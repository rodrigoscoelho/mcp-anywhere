{% extends "base.html" %}

{% block title %}Add New Server - MCP Anywhere{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <h2 class="text-2xl font-bold mb-6">Add MCP Server</h2>

    <form method="POST" action="/servers/add" class="space-y-6" id="add-server-form">
        <input type="hidden" name="config_mode" id="config-mode-input" value="{{ config_mode or 'auto' }}">

        <div class="bg-white p-5 rounded-lg shadow">
            <p class="text-sm text-gray-600 mb-3">Choose how you want to configure your MCP server.</p>
            <div class="flex flex-wrap gap-3">
                <button type="button"
                        class="config-mode-toggle px-4 py-2 rounded-md border text-sm font-medium"
                        data-config-mode="auto">
                    Analyze with Claude
                </button>
                <button type="button"
                        class="config-mode-toggle px-4 py-2 rounded-md border text-sm font-medium"
                        data-config-mode="manual">
                    Manual configuration
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow" id="analysis-card">
            <h3 class="text-lg font-medium mb-4">Step 1: Analyze Repository (optional)</h3>
            <p class="text-sm text-gray-600 mb-4">
                Enter a GitHub repository URL to have Claude analyze the project and pre-fill the configuration.
                If you prefer to configure everything yourself, switch to manual mode.
            </p>

            <div id="manual-mode-note" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                <p class="text-sm text-blue-800">
                    Manual mode is active. You can skip the analysis and complete the form below using the guidance tooltips.
                    Switch back to automatic mode at any time to run the repository analysis.
                </p>
            </div>

            <div class="mb-4">
                <label for="github_url" class="block text-sm font-medium mb-2">GitHub URL</label>
                <input type="url"
                       id="github_url"
                       name="github_url"
                       value="{{ form_values.github_url or '' }}"
                       class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="https://github.com/owner/repo">
                <p class="text-xs text-gray-500 mt-1">URL of the repository that contains the MCP server.</p>
                {% if errors and errors.github_url %}
                    <p class="text-red-600 text-sm mt-1">{{ errors.github_url[0] }}</p>
                {% endif %}
            </div>

            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-yellow-400 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                    <p class="text-sm text-yellow-700">
                        <strong>Please be patient:</strong> analyzing a new repository can take a few minutes while we inspect the code,
                        build the container image, and discover available tools.
                    </p>
                </div>
            </div>

            <button type="submit"
                    name="analyze"
                    id="analyze-btn"
                    hx-post="/servers/add"
                    hx-target="#configuration-form"
                    hx-include="[name='github_url']"
                    hx-indicator="#analyze-btn .htmx-indicator"
                    class="btn-primary px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center"
                    style="--tw-ring-color: var(--mint-dark);">
                <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                <div class="htmx-indicator hidden inline w-4 h-4 mr-2 animate-spin">
                    <svg viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <span>Analyze with Claude</span>
            </button>
        </div>

        <div id="configuration-form">
            {% include "partials/analysis_result.html" %}
        </div>
    </form>
</div>

<script>
(function() {
    const form = document.getElementById('add-server-form');
    if (!form) {
        return;
    }

    const modeInput = document.getElementById('config-mode-input');
    const modeButtons = Array.from(document.querySelectorAll('.config-mode-toggle'));
    const analyzeButton = document.getElementById('analyze-btn');
    const manualNote = document.getElementById('manual-mode-note');

    function setButtonState(selectedMode) {
        modeButtons.forEach((button) => {
            const isActive = button.dataset.configMode === selectedMode;
            button.classList.toggle('bg-mint-100', isActive);
            button.classList.toggle('border-mint-500', isActive);
            button.classList.toggle('text-mint-900', isActive);
            button.setAttribute('aria-pressed', String(isActive));
        });

        const manualMode = selectedMode === 'manual';
        if (analyzeButton) {
            analyzeButton.disabled = manualMode;
            analyzeButton.classList.toggle('opacity-60', manualMode);
            analyzeButton.classList.toggle('cursor-not-allowed', manualMode);
        }
        if (manualNote) {
            manualNote.classList.toggle('hidden', !manualMode);
        }
    }

    modeButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const selectedMode = button.dataset.configMode || 'auto';
            modeInput.value = selectedMode;
            setButtonState(selectedMode);
        });
    });

    setButtonState(modeInput.value || 'auto');

    function initializeEnvCounter() {
        const container = document.getElementById('env-vars-container');
        if (!container) {
            window.envVarCounter = 0;
            return;
        }
        const declared = container.dataset.count;
        if (declared) {
            window.envVarCounter = parseInt(declared, 10) || 0;
        } else {
            window.envVarCounter = container.querySelectorAll('.env-var-row').length;
        }
    }

    window.addEnvVar = function addEnvVar() {
        const container = document.getElementById('env-vars-container');
        if (!container) {
            return;
        }
        if (typeof window.envVarCounter !== 'number') {
            initializeEnvCounter();
        }
        const index = window.envVarCounter;
        const row = document.createElement('div');
        row.className = 'env-var-row border border-gray-200 rounded-md p-3';
        row.innerHTML = `
            <div class="flex items-start justify-between mb-3">
                <span class="text-sm font-medium text-gray-700">Environment Variable ${index + 1}</span>
                <button type="button" class="text-red-600 hover:text-red-800 text-sm" onclick="removeEnvVar(this)">Remove</button>
            </div>
            <div class="grid gap-3 sm:grid-cols-2">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">Key</label>
                    <input type="text" name="env_key_${index}" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="VARIABLE_NAME" required>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">Value</label>
                    <input type="password" name="env_value_${index}" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter value">
                </div>
            </div>
            <div class="mt-3">
                <label class="block text-xs font-semibold text-gray-600 mb-1">Description</label>
                <textarea name="env_desc_${index}" rows="2" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Why does the server need this variable?"></textarea>
            </div>
            <div class="mt-3">
                <label class="inline-flex items-center text-xs text-gray-600">
                    <input type="checkbox" name="env_required_${index}" value="true" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <span class="ml-2">Required for successful startup</span>
                </label>
            </div>
        `;
        container.appendChild(row);
        window.envVarCounter += 1;
        container.dataset.count = String(window.envVarCounter);
    };

    window.removeEnvVar = function removeEnvVar(button) {
        const row = button.closest('.env-var-row');
        if (!row) {
            return;
        }
        const container = row.parentElement;
        row.remove();
        if (container) {
            const count = container.querySelectorAll('.env-var-row').length;
            container.dataset.count = String(count);
        }
    };

    document.body.addEventListener('htmx:afterSwap', (event) => {
        if (event.detail && event.detail.target && event.detail.target.id === 'configuration-form') {
            initializeEnvCounter();
        }
    });

    initializeEnvCounter();
})();
</script>
{% endblock %}
